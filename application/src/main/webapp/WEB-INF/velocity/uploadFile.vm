#parse("macros/macros.vm")
<!DOCTYPE html>
<html lang="en">
    #@head()
    <title>Add song</title>
    <script src="//cdn.jsdelivr.net/bootstrap.tagsinput/0.4.2/bootstrap-tagsinput.min.js"></script>
    <link href="/resources/css/filespage.css" rel="stylesheet">
    <script src="resources/js/track.js"></script>
    #end

    #navigation([
    {"isActive": false, "url": "#springUrl('/main')", "title": "Main"},
    {"isActive": false, "url": "#springUrl('/search')", "title": "Search"},
    {"isActive": true, "url": "#springUrl('/uploadFile')", "title": "Add track"}
    ])
    #@body()
    <div class="container">
        <div class="col-md-4 col-md-offset-4 well  ">
            <div id="result" role="alert"></div>
            #@form("uploadForm" "/files?${_csrf.parameterName}=${_csrf.token}" "POST" "multipart/form-data")
                <input type="text" name="artist" id="inputArtist" class="form-control" placeholder="Artist"
                       required/>
                <input type="text" name="name" id="inputTitle" class="form-control" placeholder="Title" required/>

                <div class="form-group">
                    <h4 class="control-label text-center">Tags</h4>
                    <input type="text" name="tags" id="tags" class="form-control"
                           data-role="tagsinput" placeholder="New tag"/>
                </div>

                <div class="text-center">
                    <label class="btn btn-default btn-file">
                        Browse file<input type="file" name="file" id="file" style="display:none;" required>
                    </label>
                    <button type="button" class="btn btn-default btn-primary" onclick="uploadJqueryForm()">Add song
                    </button>
                    <div id="fileName" class="control-label" role="alert"></div>
                </div>
            #end
        </div>
    </div>
    #end
    #footer()
<script type="text/javascript">
    const max_length_error = 200;
    var track = new Track();

    function showFilename() {
        var filename = $('#file').val();
        filename = filename.substring(filename.lastIndexOf("\\") + 1, filename.length);
        $('#fileName').html(filename);
    }

    function clearInputs() {
        $('#inputArtist').val('');
        $('#inputTitle').val('');
        $('#tags').tagsinput('removeAll');
    }

    $('#file').change(function () {
        $('#result').hide();
        showFilename()
    });

    function isEmptyInputs() {
        if ($('#inputArtist').val() == "" || $('#inputTitle').val() == "" || $('#file').val() == "") {
            return true;
        } else {
            return false;
        }
    }

    function isCorrectSize() {
        if ($('#inputArtist').val().length <= 30 && $('#inputArtist').val().length >= 2
                && $('#inputTitle').val().length <= 30 && $('#inputTitle').val().length >= 2) {
            return true;
        } else {
            return false;
        }
    }

    function verifyFields() {
        if (isEmptyInputs()) {
            showMessage("Fill all fields", "warning");
            return false;
        }
        if (!isCorrectSize()) {
            showMessage("Size of fields must be from 2 to 30", "warning");
            return false;
        }
        return true;
    }

    function showMessage(message, type) {
        $("#result").removeClass();
        $('#result').addClass("alert collapse alert-" + type);
        $('#result').html(message);
        $('#result').show();
    }

    function uploadJqueryForm() {
        if (!verifyFields()) {
            return;
        }


        var obj = new Object();
        obj.artist = $('#inputArtist').val();
        obj.name = $('#inputTitle').val();
        obj.location = "unknown";
        if ($('#tags').val() != "") {
            obj.tags = $('#tags').val().split(",");
        }
        var formData = new FormData();
        formData.append("track", new Blob([JSON.stringify(obj)], {
            type: "application/json"
        }));
        formData.append("file", $('#file')[0].files[0]);
        track.createJson(formData)
                .then(function (data) {
                    showMessage(data, "success");
                    clearInputs();
                })
                .then(null, function (xhr, status, error) {
                    if (xhr.responseText.length < max_length_error) {
                        showMessage(xhr.responseText, "danger");
                    } else {
                        showMessage(error, "danger");
                    }
                });
    }

</script>
</html>